<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="eu.greenhouseinnovation.selly.common.model.dao.OrderDao">

    <!-- Queries: -->

    <select id="getById" parameterType="String" resultType="Order" resultMap="OrderResult">
        SELECT orders.*,
        users.dateCreated as userDateCreated,
        users.dateModified as userDateModified,
        users.firstName as userFirstName,
        users.lastName as userLastName,
        users.email as userEmail,
        users.phoneNumber as userPhoneNumber,
        users.city as userCity,
        users.verified as userIsVerified,
        deals_text.title as dealTitle
        FROM orders
        LEFT OUTER JOIN users ON orders.userId = users.id
        LEFT OUTER JOIN deals_text ON orders.dealId = deals_text.deals_id
        WHERE orders.id = #{orderId}
    </select>

    <select id="getByDealId" parameterType="String" resultType="Order" resultMap="OrderResult">
        SELECT orders.*,
        users.dateCreated as userDateCreated,
        users.dateModified as userDateModified,
        users.firstName as userFirstName,
        users.lastName as customerLastName,
        users.email as userEmail,
        users.phonenumber as userPhoneNumber,
        users.city as userCity,
        users.verified as userIsVerified,
        deals_text.title as dealTitle
        FROM orders
        LEFT OUTER JOIN users ON orders.userId = users.id
        LEFT OUTER JOIN deals_text ON orders.dealId = deals_text.deals_id
        WHERE orders.dealId = #{dealId}
    </select>

    <!--
    Currently the euro sign is hardcoded in the SQL query as a preperation for possible future other currency sign possiblities.
    -->
    <select id="getReservationOrdersByUserId" parameterType="String" resultType="Order" resultMap="ReservationOrdersByUserIdResult">
            SELECT deals_text.`title` as dealTitle,
                   deals_text.`shortDescription`,
                   d.`price` as dealPrice,
                   d.`s3picture`,
                   d.`s3thumb`,
                   st.`id` as storeId,
                   st.`name` as storeName,
                   o.`id`,
                   o.`orderNumber`,
                   o.`dateCreated` as orderCreated,
                   o.`dateModified` as orderModified,
                   o.`quantity` as orderQuantity,
                   o.`statusId` as orderStatusId,
                   o.pickup_date,
                   'â‚¬' as dealPriceCurrencySign
              FROM orders o
        INNER JOIN deals d ON d.`id`=o.`dealId`
        INNER JOIN deals_text ON deals_text.deals_id = o.`dealId`
        INNER JOIN orderstatus os ON os.`id`=o.`statusId`
        INNER JOIN store st ON st.`id`=d.`storeId`
             WHERE o.`userId` = #{userId}
               AND os.`name_i18n` NOT IN ('order_status__done','order_status__no_show');
    </select>


    <update id="markOrderCancelledByStore" parameterType="String">
        UPDATE orders
        SET statusId = 3
        WHERE id = #{orderId}
    </update>

    <update id="markOrderCancelledByConsumer" parameterType="String">
        UPDATE orders
        SET statusId = 4
        WHERE id = #{orderId}
    </update>


    <select id="getOrdersChangedSince" parameterType="Date" resultType="Order" resultMap="OrderResult">
        SELECT * FROM orders WHERE dateModified >= #{timestamp}
    </select>

    <!-- FIXME/TODO -->
    <update id="update">
        UPDATE orders
        <set>
            <if test="order.orderStatus != null">statusId = #{order.orderStatus.value},</if>
            <if test="order.dateModified != null">dateModified = #{order.dateModified},</if>
        </set>
        WHERE id = #{orderId}
    </update>


    <insert id="insert">
        INSERT INTO orders
        (id, statusId, userId, storeId, dealId, quantity, couponCode, dateCreated, dateModified, orderNumber, pickup_date)
        VALUES
        (#{mId}, #{mOrderStatus.value}, #{mUser.id}, #{mStore.id}, #{mDeal.id}, #{mQuantity}, #{mCouponCode}, #{mDateCreated}, #{mDateModified}, #{mOrderNumber}, #{mPickupDate})
    </insert>


    <!-- Result maps: -->

    <resultMap type="Order" id="OrderResult">
        <constructor>
            <idArg javaType="String" column="id"/>
        </constructor>

        <result property="mOrderNumber" column="orderNumber"/>
        <result property="mQuantity" column="quantity"/>
        <result property="mCouponCode" column="couponCode"/>

        <result property="mDateCreated" column="dateCreated"/>
        <result property="mDateModified" column="dateModified"/>

        <result property="mPickupDate" column="pickup_date"/>
        <result property="mOrderStatus" column="statusId"
                typeHandler="eu.greenhouseinnovation.selly.common.mybatis.handlers.OrderStatusTypeHandler"/>

        <!-- Create sparse objects -->
        <association property="mUser" javaType="User">
            <id property="mId" column="userId"/>
            <result property="mFirstName" column="userFirstName"/>
            <result property="mLastName" column="customerLastName"/>
            <result property="mUsername" column="username"/>
            <result property="mEmail" column="userEmail"/>
            <result property="mPhoneNumber" column="userPhoneNumber"/>
            <result property="mCity" column="userCity"/>
            <result property="mVerified" column="userIsVerified"/>
        </association>
        <association property="mStore" javaType="Store">
            <id property="mId" column="storeId"/>
            <result property="mName" column="name"/>
            <result property="mEmail" column="email"/>
        </association>
        <association property="mDeal" javaType="Deal">
            <id property="mId" column="dealId"/>
            <result property="mTitle" column="dealTitle"/>
            <result property="mSummary" column="shortDescription"/>
            <result property="mBody" column="fullDescription"/>
            <result property="mStartDate" column="startDate"/>
            <result property="mEndDate" column="endDate"/>
            <result property="mImagePath" column="s3picture"/>
            <result property="mThumbPath" column="s3thumb"/>
        </association>
    </resultMap>

    <resultMap type="Order" id="ReservationOrdersByUserIdResult">
        <constructor>
            <idArg javaType="String" column="id"/>
        </constructor>

        <result property="mOrderNumber" column="orderNumber"/>
        <result property="mQuantity" column="orderQuantity"/>

        <result property="mDateCreated" column="orderCreated"/>
        <result property="mDateModified" column="orderModified"/>

        <result property="mOrderStatus" column="orderStatusId"
                typeHandler="eu.greenhouseinnovation.selly.common.mybatis.handlers.OrderStatusTypeHandler"/>

        <result property="mPickupDate" column="pickup_date"/>

        <association property="mStore" javaType="Store">
            <result property="mName" column="storeName"/>
        </association>

        <association property="mDeal" javaType="Deal">
            <result property="mTitle" column="dealTitle"/>
            <result property="mImagePath" column="s3picture"/>
            <result property="mThumbPath" column="s3thumb"/>
            <result property="mOriginalPriceCents" column="dealPrice"/>
            <result property="mOriginalPrice" column="dealPrice"/>
            <result property="mPrice" column="dealPrice"/>
            <result property="sPriceCurrencySign" column="dealPriceCurrencySign"/>
        </association>

    </resultMap>


</mapper>
