<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="eu.greenhouseinnovation.selly.common.model.dao.PushConfigDao">

    <!-- Queries: -->

    <select id="getBackendPushConfig" resultType="BackendPushConfig" resultMap="BackendPushConfigResult">
        SELECT * FROM backend_push_config
    </select>

    <select id="getById" parameterType="String" resultType="PushConfig" resultMap="PushConfigResult">
        SELECT * FROM user_push_config WHERE id = #{configId}
    </select>

    <select id="getByUserId" parameterType="String" resultType="PushConfig" resultMap="PushConfigResult">
        SELECT * FROM user_push_config WHERE user_id = #{userId} order by date_modified desc
    </select>

    <select id="getByStoreId" parameterType="String" resultType="PushConfig" resultMap="PushConfigResult">
        SELECT * FROM user_push_config WHERE store_id = #{storeId}
    </select>

    <select id="getByLocationId" parameterType="String" resultType="PushConfig" resultMap="PushConfigResult">
        SELECT user_push_config.* FROM user_push_config
        INNER JOIN store ON store.id = user_push_config.store_id
        WHERE store.shoppingmallId = #{locationId}
    </select>

    <insert id="updateNotificationPreference" keyColumn="id" parameterType="PushConfig">
        REPLACE INTO user_push_config
        (id, user_id, store_id,
        platform, token,
        date_created, date_modified,
        pref_notify_news, pref_notify_orders_new, pref_notify_orders_updated, application, device_language)
        VALUES
        (#{id}, #{user.id}, #{store.id},
        #{platform, typeHandler=eu.greenhouseinnovation.selly.common.mybatis.handlers.DeviceFamilyHandler}, #{pushToken},
        #{dateCreated}, #{dateModified},
        #{notifyOnNews}, #{notifyOnNewOrders}, #{notifyOnOrderUpdates},
        #{application, typeHandler=eu.greenhouseinnovation.selly.common.mybatis.handlers.ApplicationHandler},
        #{deviceLanguage})
    </insert>

    <select id="getUserPushConfigByConfig" parameterType="eu.greenhouseinnovation.selly.common.model.PushConfig" resultType="eu.greenhouseinnovation.selly.common.model.PushConfig" resultMap="PushConfigResult">
        SELECT * FROM user_push_config
        WHERE user_id = #{config.user.id}
        AND id = #{config.deviceId}
        AND application = #{config.application, typeHandler=eu.greenhouseinnovation.selly.common.mybatis.handlers.ApplicationHandler}
        AND platform = #{config.platform, typeHandler=eu.greenhouseinnovation.selly.common.mybatis.handlers.DeviceFamilyHandler}
    </select>

    <select id="getPushConfig" resultType="eu.greenhouseinnovation.selly.common.model.PushConfig" resultMap="PushConfigResult">
        SELECT * FROM user_push_config
        WHERE user_id = #{userId}
        <if test="deviceId != null">AND id = #{deviceId}</if>
        <if test="platform != null">AND platform = #{platform}</if>
        <if test="application != null">AND application = #{application}</if>
        order by date_modified DESC
        limit 1
    </select>

    <insert id="insertUserPushConfig" parameterType="eu.greenhouseinnovation.selly.common.model.PushConfig">
        INSERT INTO user_push_config
        (id, user_id, store_id,
        platform, token,
        date_created, date_modified,
        pref_notify_news, pref_notify_orders_new, pref_notify_orders_updated, application, device_language)
        VALUES
        (#{config.deviceId}, #{config.user.id}, #{config.store.id},
        #{config.platform, typeHandler=eu.greenhouseinnovation.selly.common.mybatis.handlers.DeviceFamilyHandler}, #{config.pushToken},
        now(), now(),
        #{config.notifyOnNews}, #{config.notifyOnNewOrders},
        #{config.notifyOnOrderUpdates}, #{config.application, typeHandler=eu.greenhouseinnovation.selly.common.mybatis.handlers.ApplicationHandler},
        #{config.deviceLanguage})
    </insert>

    <update id="updateUserPushConfig" parameterType="eu.greenhouseinnovation.selly.common.model.PushConfig">
        UPDATE user_push_config
        <set>
            store_id = #{config.store.id},
            token = #{config.pushToken},
            date_modified = now(),
            pref_notify_news = #{config.notifyOnNews},
            pref_notify_orders_new = #{config.notifyOnNewOrders},
            pref_notify_orders_updated = #{config.notifyOnOrderUpdates},
            device_language=#{config.deviceLanguage}
        </set>
        WHERE user_id = #{config.user.id}
        AND id = #{config.deviceId}
        AND application = #{config.application, typeHandler=eu.greenhouseinnovation.selly.common.mybatis.handlers.ApplicationHandler}
        AND platform = #{config.platform, typeHandler=eu.greenhouseinnovation.selly.common.mybatis.handlers.DeviceFamilyHandler}
    </update>

    <delete id="deleteUserPushConfig" parameterType="eu.greenhouseinnovation.selly.common.model.PushConfig">
        DELETE FROM user_push_config
        WHERE user_id = #{config.user.id}
        AND id = #{config.deviceId}
        AND application = #{config.application, typeHandler=eu.greenhouseinnovation.selly.common.mybatis.handlers.ApplicationHandler}
        AND platform = #{config.platform, typeHandler=eu.greenhouseinnovation.selly.common.mybatis.handlers.DeviceFamilyHandler}
    </delete>

    <delete id="deletePushConfigForUser">
        DELETE FROM user_push_config WHERE user_id = #{user_id} AND token = #{token_id}
    </delete>

    <!-- Result maps: -->

    <resultMap type="PushConfig" id="PushConfigResult">
        <constructor>
            <idArg javaType="String" column="id"/>
        </constructor>

        <result property="platform" column="platform"
                typeHandler="eu.greenhouseinnovation.selly.common.mybatis.handlers.DeviceFamilyHandler"/>
        <result property="application" column="application"
                typeHandler="eu.greenhouseinnovation.selly.common.mybatis.handlers.ApplicationHandler"/>
        <result property="pushToken" column="token"/>
        <result property="dateCreated" column="date_created"/>
        <result property="dateModified" column="date_modified"/>
        <result property="deviceLanguage" column="device_language"/>

        <!-- Config -->
        <result property="notifyOnNews" column="pref_notify_news"/>
        <result property="notifyOnNewOrders" column="pref_notify_orders_new"/>
        <result property="notifyOnOrderUpdates" column="pref_notify_orders_updated"/>

        <!-- Create sparse objects -->
        <association property="user" javaType="User">
            <id property="mId" column="user_id"/>
        </association>
        <association property="store" javaType="Store">
            <id property="mId" column="store_id"/>
        </association>
    </resultMap>

    <resultMap type="BackendPushConfig" id="BackendPushConfigResult">
        <!-- Config -->
        <result property="mBrokerUrl" column="broker_url"/>
        <result property="mQueueName" column="queue_name"/>
        <result property="mUsername" column="username"/>
        <result property="mPassword" column="password"/>
    </resultMap>

</mapper>
